import random
import masscan
import threading
from mcstatus import JavaServer
from pymongo import MongoClient


def connectMongo():
    CONNECTION_STRING = "mongodb://root:example@127.0.0.1:27017"
    client = MongoClient(CONNECTION_STRING)
    return client['minecraft']

def massScan(database):

    collection = database["possible_servers"]

    print("Starting scan")

    # #ip ranges
    # A = list(range(1, 255))
    # B = list(range(1, 255))
    # random.shuffle(A)
    # random.shuffle(B)

    # ip_ranges = []

    # for a in A:
    #     for b in B:
    #         ip_range = f"{a}.{b}.0.0/16"
    #         ip_ranges.append(ip_range)

    ip_ranges = [
        '116.202.0.0/16',
        '116.203.0.0/16',
        '128.140.0.0/17',
        '135.181.0.0/16',
        '136.243.0.0/16',
        '138.201.0.0/16',
        '142.132.128.0/17',
        '144.76.0.0/16',
        '148.251.0.0/16',
        '157.90.0.0/16',
        '159.69.0.0/16',
        '162.55.0.0/16',
        '167.233.0.0/16',
        '167.235.0.0/16',
        '168.119.0.0/16',
        '171.25.225.0/24',
        '176.102.168.0/21',
        '176.9.0.0/16',
        '178.212.75.0/24',
        '178.63.0.0/16',
        '185.107.52.0/22',
        '185.110.95.0/24',
        '185.112.180.0/24',
        '185.12.65.0/24',
        '185.126.28.0/22',
        '185.136.140.0/23',
        '185.157.176.0/23',
        '185.157.178.0/23',
        '185.157.83.0/24',
        '185.171.224.0/22',
        '185.189.228.0/24',
        '185.189.229.0/24',
        '185.189.230.0/24',
        '185.189.231.0/24',
        '185.209.124.0/22',
        '185.213.45.0/24',
        '185.216.237.0/24',
        '185.226.99.0/24',
        '185.228.8.0/23',
        '185.242.76.0/24',
        '185.253.111.0/24',
        '185.36.144.0/22',
        '185.50.120.0/23',
        '188.34.128.0/17',
        '188.40.0.0/16',
        '193.110.6.0/23',
        '193.163.198.0/24',
        '193.223.77.0/24',
        '193.25.170.0/23',
        '194.145.226.0/24',
        '194.35.12.0/23',
        '194.42.180.0/22',
        '194.42.184.0/22',
        '194.62.106.0/24',
        '195.201.0.0/16',
        '195.248.224.0/24',
        '195.60.226.0/24',
        '195.96.156.0/24',
        '197.242.84.0/22',
        '213.133.96.0/19',
        '213.232.193.0/24',
        '213.239.192.0/18',
        '217.78.237.0/24',
        '23.88.0.0/17',
        '45.136.70.0/23',
        '45.148.28.0/22',
        '45.15.120.0/22',
        '46.4.0.0/16',
        '49.12.0.0/16',
        '49.13.0.0/16',
        '5.161.0.0/16',
        '5.75.128.0/17',
        '5.9.0.0/16',
        '65.108.0.0/16',
        '65.109.0.0/16',
        '65.21.0.0/16',
        '78.46.0.0/15',
        '83.219.100.0/22',
        '83.243.120.0/22',
        '85.10.192.0/18',
        '88.198.0.0/16',
        '88.99.0.0/16',
        '91.107.128.0/17',
        '91.190.240.0/21',
        '91.233.8.0/22',
        '94.130.0.0/16',
        '94.154.121.0/24',
        '95.216.0.0/16',
        '95.217.0.0/16'
    ]

    while True:
        random.shuffle(ip_ranges)

        for ip_range in ip_ranges:
            try:
                mas = masscan.PortScanner()
                print(f"Scanning {ip_range}")
                mas.scan(ip_range, ports='25565', arguments='--max-rate 200000')
                ips = list(mas._scan_result['scan'].keys())
                if ips:    
                    print(ips)
                    for ip in ips:
                        collection.update_one({'ip': ip},{ "$set": { 'ip': ip }}, upsert=True)


            except Exception as e:
                print(f"Scan exception: {e}")

        print("Finished scan, go again")
        


if __name__ == "__main__":

    database = connectMongo()
    massScan(database)